package org.opendatakit.briefcase.ui.automation;

import static org.opendatakit.briefcase.ui.reused.FileChooser.directory;

import java.awt.GridBagConstraints;
import java.awt.GridBagLayout;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.PrintWriter;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.Optional;
import javax.swing.JButton;
import javax.swing.JComponent;
import javax.swing.JLabel;
import javax.swing.JPanel;
import javax.swing.JTextField;
import org.opendatakit.briefcase.util.StringUtils;

@SuppressWarnings("checkstyle:MethodName")
public class AutomationPanelForm {
  public JPanel container;
  private JLabel scriptDirLabel;
  private JTextField scriptDirField;
  private JButton scriptDirChooseButton;
  private JButton generateScriptButton;

  public AutomationPanelForm() {
    $$$setupUI$$$();
    scriptDirChooseButton.addActionListener(__ ->
        directory(container, fileFrom(scriptDirField))
            .choose()
            .ifPresent(file -> setScriptDir(Paths.get(file.toURI()))));
    generateScriptButton.addActionListener(__ -> {
      if (isOnWindows()) {
        generateScript("automation.bat", "echo %JAVA_HOME%");
      } else {
        generateScript("automation.sh", "echo $JAVA_HOME");
      }
    });
  }

  private void setScriptDir(Path path) {
    scriptDirField.setText(path.toString());
  }

  private static Optional<File> fileFrom(JTextField textField) {
    return Optional.ofNullable(textField.getText())
        .filter(StringUtils::nullOrEmpty)
        .map(path -> Paths.get(path).toFile());
  }

  private void generateScript(String fileName, String contents) {
    File script = new File(scriptDirField.getText(), fileName);
    try {
      PrintWriter printWriter = new PrintWriter(script);
      printWriter.print(contents);
      printWriter.close();
    } catch (FileNotFoundException e) {
      System.err.println(e.getMessage());
    }
  }

  private boolean isOnWindows() {
    String osName = System.getProperty("os.name");
    return osName.toLowerCase().contains("windows");
  }


  /**
   * Method generated by IntelliJ IDEA GUI Designer
   * >>> IMPORTANT!! <<<
   * DO NOT edit this method OR call it in your code!
   *
   * @noinspection ALL
   */
  private void $$$setupUI$$$() {
    container = new JPanel();
    container.setLayout(new GridBagLayout());
    scriptDirLabel = new JLabel();
    scriptDirLabel.setText("Script Location");
    GridBagConstraints gbc;
    gbc = new GridBagConstraints();
    gbc.gridx = 0;
    gbc.gridy = 1;
    gbc.anchor = GridBagConstraints.WEST;
    container.add(scriptDirLabel, gbc);
    final JPanel spacer1 = new JPanel();
    gbc = new GridBagConstraints();
    gbc.gridx = 1;
    gbc.gridy = 1;
    gbc.fill = GridBagConstraints.HORIZONTAL;
    container.add(spacer1, gbc);
    scriptDirField = new JTextField();
    scriptDirField.setEditable(false);
    gbc = new GridBagConstraints();
    gbc.gridx = 2;
    gbc.gridy = 1;
    gbc.weightx = 1.0;
    gbc.anchor = GridBagConstraints.WEST;
    gbc.fill = GridBagConstraints.HORIZONTAL;
    container.add(scriptDirField, gbc);
    scriptDirChooseButton = new JButton();
    scriptDirChooseButton.setText("Choose...");
    gbc = new GridBagConstraints();
    gbc.gridx = 3;
    gbc.gridy = 1;
    gbc.fill = GridBagConstraints.HORIZONTAL;
    container.add(scriptDirChooseButton, gbc);
    generateScriptButton = new JButton();
    generateScriptButton.setText("Generate Script");
    gbc = new GridBagConstraints();
    gbc.gridx = 2;
    gbc.gridy = 2;
    gbc.fill = GridBagConstraints.HORIZONTAL;
    container.add(generateScriptButton, gbc);
    final JPanel spacer2 = new JPanel();
    gbc = new GridBagConstraints();
    gbc.gridx = 2;
    gbc.gridy = 3;
    gbc.weighty = 1.0;
    gbc.fill = GridBagConstraints.VERTICAL;
    container.add(spacer2, gbc);
    final JPanel spacer3 = new JPanel();
    gbc = new GridBagConstraints();
    gbc.gridx = 2;
    gbc.gridy = 0;
    gbc.fill = GridBagConstraints.VERTICAL;
    container.add(spacer3, gbc);
  }

  /**
   * @noinspection ALL
   */
  public JComponent $$$getRootComponent$$$() {
    return container;
  }
}
